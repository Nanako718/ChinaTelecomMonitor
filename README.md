# ChinaTelecomMonitor

> ä¸­å›½ç”µä¿¡è¯è´¹ã€é€šè¯ã€æµé‡å¥—é¤ç”¨é‡æŸ¥è¯¢ API æœåŠ¡

æœ¬é¡¹ç›®é€šè¿‡æ¨¡æ‹Ÿç™»å½•ä¸­å›½ç”µä¿¡æ¥å£ï¼Œè·å–æ‰‹æœºè¯è´¹ã€é€šè¯æ—¶é•¿ã€æµé‡ä½¿ç”¨æƒ…å†µç­‰æ•°æ®ã€‚å¯éƒ¨ç½²åœ¨æœåŠ¡å™¨ã€x86è½¯è·¯ç”±ç­‰è®¾å¤‡ä¸Šè¿è¡Œï¼Œä¸ºç¬¬ä¸‰æ–¹ç³»ç»Ÿæä¾›æ•°æ®æŸ¥è¯¢æ¥å£ã€‚

## ğŸ“‹ ç›®å½•

- [ç‰¹æ€§](#-ç‰¹æ€§)
- [ä½¿ç”¨æ¡ˆä¾‹](#-ä½¿ç”¨æ¡ˆä¾‹)
- [å¿«é€Ÿå¼€å§‹](#-å¿«é€Ÿå¼€å§‹)
  - [Docker éƒ¨ç½²](#docker-éƒ¨ç½²)
- [API æ–‡æ¡£](#-api-æ–‡æ¡£)
- [å¸¸è§é—®é¢˜](#-å¸¸è§é—®é¢˜)
- [è‡´è°¢](#-è‡´è°¢)

## âœ¨ ç‰¹æ€§

- âœ… **Token ç¼“å­˜æœºåˆ¶** - æœ¬åœ°ä¿å­˜ç™»å½• tokenï¼Œæœ‰æ•ˆæœŸå†…è‡ªåŠ¨å¤ç”¨ï¼Œé¿å…é‡å¤ç™»å½•
- âœ… **Docker éƒ¨ç½²** - ä¸€é”®éƒ¨ç½² API æŸ¥è¯¢æœåŠ¡
- âœ… **RESTful API** - æä¾›æ ‡å‡† REST APIï¼Œæ–¹ä¾¿ç¬¬ä¸‰æ–¹ç³»ç»Ÿé›†æˆ
- âœ… **é«˜å¹¶å‘æ”¯æŒ** - æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘æŸ¥è¯¢ï¼Œæ€§èƒ½ç¨³å®š
- âœ… **æ•°æ®æŒä¹…åŒ–** - ç™»å½•ä¿¡æ¯æŒä¹…åŒ–å­˜å‚¨ï¼Œå®¹å™¨é‡å¯åæ•°æ®ä¸ä¸¢å¤±

## ğŸ¯ ä½¿ç”¨æ¡ˆä¾‹

- [iOS è‡ªåˆ¶ UI é¢æ¿](https://github.com/Cp0204/ChinaTelecomMonitor/issues/18) - By: LRZ9712
- [HomeAssistant æ’ä»¶é›†æˆ](https://bbs.hassbian.com/thread-29129-1-1.html) [CTMç”µä¿¡](https://github.com/hlhk2017/ChinaTelecomMonitor-Homeassistant-Integration) - By: hlhk2017
- [HomeAssistant ä¸­å›½ç”µä¿¡æ¥å…¥è§†é¢‘æ•™ç¨‹](https://www.bilibili.com/video/BV1F5NLe7EUJ/) - By: ç±³å“ŸMIO

## ğŸš€ å¿«é€Ÿå¼€å§‹

### Docker éƒ¨ç½²

æœ¬é¡¹ç›®æä¾› Docker å®¹å™¨åŒ–éƒ¨ç½²æ–¹æ¡ˆï¼Œæ–¹ä¾¿å¿«é€Ÿéƒ¨ç½²å’Œä½¿ç”¨ã€‚API æœåŠ¡ä¸»è¦ç”¨äºç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼ˆå¦‚ HomeAssistant ç­‰ï¼‰è·å–ç”µä¿¡å¥—é¤ä½¿ç”¨ä¿¡æ¯ã€‚

> âš ï¸ **å®‰å…¨è­¦å‘Š**
> 
> ç™»å½•æˆåŠŸåï¼Œä¼šåœ¨æœåŠ¡å™¨ `config/login_info.db` (SQLite æ•°æ®åº“) ä¸­**è®°å½•è´¦å·åŒ…æ‹¬ token åœ¨å†…çš„æ•æ„Ÿä¿¡æ¯**ã€‚token é•¿æœŸæœ‰æ•ˆï¼Œç›´åˆ°åœ¨å…¶ä»–åœ°æ–¹ç™»å½•è¢«æŒ¤ä¸‹çº¿ã€‚ç¨‹åºè·å–æ•°æ®æ—¶ä¼šå…ˆå°è¯•ç”¨å·²è®°å½•çš„ token å»è¯·æ±‚ï¼Œé¿å…é‡å¤å‘å‡ºç™»å½•è¯·æ±‚ã€‚
> 
> **âš ï¸ è¯·å‹¿ä½¿ç”¨ä»–äººéƒ¨ç½²çš„ API æœåŠ¡ï¼Œä»¥å…æ•æ„Ÿä¿¡æ¯å¤–æ³„ âš ï¸**

#### æ„å»º Docker é•œåƒ

åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ„å»ºé•œåƒï¼ˆæ”¯æŒè·¨å¹³å°æ„å»ºï¼Œé€‚ç”¨äº Mac æ„å»º x86 é•œåƒï¼‰ï¼š

```bash
docker build --platform linux/amd64 -t dtzsghnr/chinatelecommonitor:latest .
```

#### ä½¿ç”¨ Docker å‘½ä»¤éƒ¨ç½²

```bash
# åˆ›å»ºæœ¬åœ°æ•°æ®ç›®å½•ï¼ˆç”¨äºæŒä¹…åŒ–æ•°æ®åº“å’Œé…ç½®ï¼‰
mkdir -p ./china-telecom-monitor/config

# è¿è¡Œå®¹å™¨ï¼ˆæ•°æ®æŒä¹…åŒ–åˆ°æœ¬åœ° ./china-telecom-monitor/config ç›®å½•ï¼‰
docker run -d \
  --name china-telecom-monitor \
  -p 10000:10000 \
  -v $(pwd)/china-telecom-monitor/config:/app/config \
  --network bridge \
  --restart unless-stopped \
  dtzsghnr/chinatelecommonitor:latest
```

#### ä½¿ç”¨ Docker Compose éƒ¨ç½²

åˆ›å»º `docker-compose.yml` æ–‡ä»¶ï¼š

```yaml
name: china-telecom-monitor
services:
  china-telecom-monitor:
    image: dtzsghnr/chinatelecommonitor:latest
    container_name: china-telecom-monitor
    network_mode: bridge
    ports:
      - 10000:10000
    volumes:
      # æ•°æ®æŒä¹…åŒ–ï¼šå°†å®¹å™¨å†…çš„ /app/config ç›®å½•æŒ‚è½½åˆ°æœ¬åœ°
      # æ•°æ®åº“æ–‡ä»¶ login_info.db ä¼šä¿å­˜åœ¨æœ¬åœ°ï¼Œå®¹å™¨é‡å¯åæ•°æ®ä¸ä¸¢å¤±
      - ./china-telecom-monitor/config:/app/config
    restart: unless-stopped
```

ç„¶åè¿è¡Œï¼š

```bash
docker-compose up -d
```

#### æ•°æ®æŒä¹…åŒ–è¯´æ˜

- é€šè¿‡ `-v` å‚æ•°å°†å®¹å™¨çš„ `/app/config` ç›®å½•æŒ‚è½½åˆ°æœ¬åœ°ç›®å½•
- æ•°æ®åº“æ–‡ä»¶ `login_info.db` ä¼šä¿å­˜åœ¨æœ¬åœ°ï¼Œå®¹å™¨åˆ é™¤é‡å»ºåæ•°æ®ä¸ä¼šä¸¢å¤±
- **å»ºè®®å®šæœŸå¤‡ä»½** `./china-telecom-monitor/config` ç›®å½•ï¼ŒåŒ…å«é‡è¦çš„ç™»å½• token ä¿¡æ¯


## ğŸ“– API æ–‡æ¡£

æ‰€æœ‰æ¥å£å‡æ”¯æŒ `GET` å’Œ `POST` æ–¹æ³•ï¼Œé»˜è®¤ç«¯å£ä¸º `10000`ã€‚

### æ¥å£åˆ—è¡¨

| æ¥å£è·¯å¾„ | è¯´æ˜ | å¤‡æ³¨ |
| -------- | ---- | ---- |
| `/login` | ç™»å½•æ¥å£ | è¿”å›ç”¨æˆ·ä¿¡æ¯ï¼›æ— éœ€å•ç‹¬è¯·æ±‚ï¼Œå…¶ä»–æ¥å£æœªç™»å½•æ—¶ä¼šè‡ªåŠ¨ç™»å½• |
| `/qryImportantData` | æŸ¥è¯¢ä¸»è¦ä¿¡æ¯ | è¿”å›è¯è´¹ã€é€šè¯ã€æµé‡ç­‰æ€»ç”¨é‡ä¿¡æ¯ |
| `/userFluxPackage` | æŸ¥è¯¢æµé‡åŒ…æ˜ç»† | è¿”å›è¯¦ç»†çš„æµé‡åŒ…ä½¿ç”¨æƒ…å†µ |
| `/qryShareUsage` | æŸ¥è¯¢å…±äº«å¥—é¤ | è¿”å›å…±äº«å¥—é¤å„å·ç ç”¨é‡ |
| `/summary` | ç®€åŒ–æ•°æ®æ¥å£ | `/qryImportantData` çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œè¿”å›æ ¼å¼åŒ–çš„æ•°æ® |

### è¯·æ±‚æ–¹å¼

#### GET è¯·æ±‚ç¤ºä¾‹

```bash
# ä½¿ç”¨ URL å‚æ•°
curl "http://127.0.0.1:10000/summary?phonenum=18912345678&password=123456"
```

#### POST è¯·æ±‚ç¤ºä¾‹

```bash
curl --request POST \
  --url http://127.0.0.1:10000/summary \
  --header 'Content-Type: application/json' \
  --data '{
    "phonenum": "18912345678",
    "password": "123456"
  }'
```

### å“åº”æ ¼å¼

#### `/summary` æ¥å£å“åº”ç¤ºä¾‹

```json
{
  "phonenum": "18912345678",
  "balance": 0,
  "voiceUsage": 39,
  "voiceBalance": 2211,
  "voiceTotal": 2250,
  "flowUse": 7366923,
  "flowTotal": 7366923,
  "flowOver": 222222,
  "commonUse": 7273962,
  "commonTotal": 25550446,
  "commonOver": 222222,
  "specialUse": 92961,
  "specialTotal": 215265280,
  "createTime": "2024-05-12 14:13:28",
  "flowItems": [
    {
      "name": "å›½å†…é€šç”¨æµé‡(è¾¾é‡é™é€Ÿ)",
      "use": 10241024,
      "balance": 0,
      "total": 10241024
    },
    {
      "name": "å›½å†…é€šç”¨æµé‡(éç•…äº«)",
      "use": 1,
      "balance": 10241023,
      "total": 10241024
    },
    {
      "name": "ä¸“ç”¨æµé‡",
      "use": 1,
      "balance": 10241023,
      "total": 10241024
    }
  ]
}
```

#### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
| ---- | ---- | ---- |
| `phonenum` | string | æ‰‹æœºå·ç  |
| `balance` | number | è´¦æˆ·ä½™é¢ï¼ˆå•ä½ï¼šåˆ†ï¼‰ |
| `voiceUsage` | number | è¯­éŸ³é€šè¯å·²ä½¿ç”¨æ—¶é•¿ï¼ˆå•ä½ï¼šåˆ†é’Ÿï¼‰ |
| `voiceBalance` | number | è¯­éŸ³é€šè¯å‰©ä½™æ—¶é•¿ï¼ˆå•ä½ï¼šåˆ†é’Ÿï¼‰ |
| `voiceTotal` | number | è¯­éŸ³é€šè¯æ€»æ—¶é•¿ï¼ˆå•ä½ï¼šåˆ†é’Ÿï¼‰ |
| `flowUse` | number | æ€»æµé‡å·²ä½¿ç”¨é‡ï¼ˆå•ä½ï¼šKBï¼‰ |
| `flowTotal` | number | æ€»æµé‡æ€»é‡ï¼ˆå•ä½ï¼šKBï¼‰ |
| `flowOver` | number | æ€»æµé‡è¶…é‡ï¼ˆå•ä½ï¼šKBï¼‰ |
| `commonUse` | number | é€šç”¨æµé‡å·²ä½¿ç”¨é‡ï¼ˆå•ä½ï¼šKBï¼‰ |
| `commonTotal` | number | é€šç”¨æµé‡æ€»é‡ï¼ˆå•ä½ï¼šKBï¼‰ |
| `commonOver` | number | é€šç”¨æµé‡è¶…é‡ï¼ˆå•ä½ï¼šKBï¼‰ |
| `specialUse` | number | ä¸“ç”¨æµé‡å·²ä½¿ç”¨é‡ï¼ˆå•ä½ï¼šKBï¼‰ |
| `specialTotal` | number | ä¸“ç”¨æµé‡æ€»é‡ï¼ˆå•ä½ï¼šKBï¼‰ |
| `createTime` | string | æ•°æ®åˆ›å»ºæ—¶é—´ |
| `flowItems` | array | æµé‡ç±»å‹åˆ—è¡¨ï¼ŒåŒ…å«å„æµé‡åŒ…çš„è¯¦ç»†ä¿¡æ¯ |

## â“ å¸¸è§é—®é¢˜

### 1. ç™»å½•å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

- æ£€æŸ¥æ‰‹æœºå·å’Œå¯†ç æ˜¯å¦æ­£ç¡®
- ç¡®è®¤è´¦å·æœªè¢«å…¶ä»–è®¾å¤‡ç™»å½•ï¼ˆä¼šè¢«æŒ¤ä¸‹çº¿ï¼‰
- å¦‚æœ token è¿‡æœŸï¼Œç¨‹åºä¼šè‡ªåŠ¨é‡æ–°ç™»å½•

### 2. å¦‚ä½•æŸ¥çœ‹æ•°æ®åº“ä¸­çš„ç™»å½•ä¿¡æ¯ï¼Ÿ

å¯ä»¥ä½¿ç”¨é¡¹ç›®æä¾›çš„ `view_db.py` è„šæœ¬æŸ¥çœ‹ï¼š

```bash
python view_db.py
```

### 3. æ•°æ®æŒä¹…åŒ–åœ¨å“ªé‡Œï¼Ÿ

æ•°æ®ä¿å­˜åœ¨ `./china-telecom-monitor/config/login_info.db` æ–‡ä»¶ä¸­ï¼ŒåŒ…å«ç™»å½• token ç­‰æ•æ„Ÿä¿¡æ¯ï¼Œè¯·å¦¥å–„ä¿ç®¡ã€‚

### 4. æ”¯æŒå¤šè´¦å·å—ï¼Ÿ

æ”¯æŒã€‚æ¯ä¸ªè´¦å·çš„ç™»å½•ä¿¡æ¯ä¼šåˆ†åˆ«å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œé€šè¿‡ `phonenum` å‚æ•°åŒºåˆ†ã€‚

## ğŸ™ è‡´è°¢

æœ¬é¡¹ç›®å¤§é‡å‚è€ƒå…¶ä»–é¡¹ç›®çš„ä»£ç ï¼Œåœ¨æ­¤è¡¨ç¤ºæ„Ÿè°¢ï¼

- [ChinaTelecomMonitor](https://github.com/LambdaExpression/ChinaTelecomMonitor) - Go è¯­è¨€å®ç°ç‰ˆæœ¬
- [boxjs](https://github.com/gsons/boxjs) - æ„Ÿè°¢å¼€æºæä¾›çš„ç”µä¿¡æ¥å£
